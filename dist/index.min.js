!function(){function e(e,t){this.el=e,this.config=o({},v,t),this.$init()}function t(){var e=[].slice.call(arguments),t=e.shift();h(e,function(e){t.appendChild(e)})}function i(e){e&&("function"==typeof e.remove?e.remove():e.parentNode.removeChild(e))}function s(e){for(var t in e)return!1;return!0}function n(e){return[].indexOf.call(e.parentNode.children,e)}function l(e,t,i){var s=document.createElement(e);return t&&o(s,t),i&&o(s.dataset,i),s}function a(e){return e?"?"+Object.keys(e).map(function(t){return t+"="+e[t]}).join("&"):""}function r(e,t){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState&&200===i.status){if(i.responseText){var e=JSON.parse(i.responseText);e?t(e):console.error(e)}}else if(i.status&&200!==i.status)throw new Error(i.responseText)},i.withCredentials=!0,i.open(e.method||"GET",e.url+a(e.params)),i.send()}function c(e,t,i,s,n){e.addEventListener(i,function(i){for(var l=i.target;l&&l!==e;)l.classList.contains(t)&&(s(l),n&&i.stopPropagation()),l=l.parentNode})}function o(){if("function"==typeof Object.assign)return Object.assign.apply(null,arguments);var e=[].slice.call(arguments),t=e.shift();return t||(t={}),e.forEach(function(e){for(var i in e)t[i]=e[i]}),t}function h(e,t){if(e){if(Array.isArray(e)&&"function"==typeof e.forEach)return void e.forEach(t);for(var i in e)e.hasOwnProperty(i)&&t(e[i])}}var d={},u={"交易平台BU":{id:"bu",params:{time:"hour"}},"红包":{id:"redReward"},BOD:{id:"bod"},"高校":{id:"business/gx"},"白领":{id:"business/bl"},"早餐":{id:"breakfast"},"城市补贴与优惠":{id:"cityAllowance"},"城市":{id:"cityAllowance"}},f="/api/other/filter/",p="//unpkg.com/eleme-area-selector/dist/style.css",v={api:f,style:p,selectItemStyle:{height:27,display:20},selectSliceLength:200,typeMap:u,onReady:null,onChange:null,onTypeChange:null,loadingMessage:["正在加载资源...","正在请求数据..."],types:["交易平台BU"],cache:!1,cacheKey:"EAS-CACHE",responseHandler:null};e.prototype={$init:function(){if(this.el.innerHTML=this.config.loadingMessage[0],this.$initCache(),document.querySelector("[data-id=EAS-Style]"))this.$setCurrentType();else{var e=l("link",{rel:"stylesheet",href:this.config.style},{id:"EAS-Style"}),i=this;e.onload=function(){i.$setCurrentType()},t(document.head,e)}},$setCurrentType:function(e){e||(e=this.config.types[0]),this.config.onTypeChange&&this.config.onTypeChange(e),this.currentType=e,this.$load()},$load:function(){this.el.innerHTML=this.config.loadingMessage[1],this.model=[],this.data={},this.keyword="",this.selects={},s(this.refs)||this.$clear(),this.refs={},d[this.currentType]?this.$build(d[this.currentType]):r({url:this.config.api+this.config.typeMap[this.currentType].id,params:this.config.typeMap[this.currentType].params},function(e){this.config.responseHandler?this.config.responseHandler(e,this.$build.bind(this)):this.$build(e)}.bind(this))},$clear:function(){h(this.$eventsHandlerRemove,function(e){e()}),this.$eventsHandlerRemove=[],i(this.refs.container),i(this.refs.selectContainer)},$destroy:function(){this.$clear(),this.$saveCache(),this.config.onChange=null,this.config.onReady=null,this.config.onTypeChange=null;var e=this;h(this,function(t){"function"==typeof t&&(e[t]=null)})},$addEventListener:function(e,t,i){e.addEventListener(t,i),this.$eventsHandlerRemove.push(function(){e.removeEventListener(t,i)})},$build:function(e){if(!s(e)){this.data=e,d[this.currentType]=e;var i=this.refs,a=this;this.$eventsHandlerRemove=[],i.container=l("div",{className:"eas-container"}),i.inputContainer=l("div",{className:"input-container"}),i.typeBox=l("div",{className:"type-box"}),i.type=l("div",{className:"current-type"}),i.typeList=l("ul",{className:"type-list"}),i.input=l("input",{className:"eas-input",type:"search"}),i.resultContainer=l("div",{className:"result-container"}),i.clearAll=l("div",{className:"clear-all",innerHTML:"清除全部"}),i.tags=l("div",{className:"eas-tags"}),i.selectContainer=l("div",{className:"eas-selects"}),this.el.innerHTML="",t(i.container,i.inputContainer,i.resultContainer),t(i.typeBox,i.type,i.typeList),t(i.inputContainer,i.typeBox,i.input),t(i.resultContainer,i.tags,i.clearAll),this.refs.type.innerHTML=this.currentType,this.$buildTypeList(),this.$addEventListener(document.body,"click",function(){a.$hideSelect(0)}),this.$addEventListener(this.refs.input,"click",function(e){a.$showSelect(),e.stopPropagation()}),this.$addEventListener(this.refs.input,"input",function(){a.$search()}),this.$addEventListener(this.refs.clearAll,"click",function(){a.$clearAll()}),c(this.refs.typeList,"type-list-item","click",function(e){a.$setCurrentType(e.textContent)},!0),c(this.refs.selectContainer,"eas-select-item","mousemove",function(e){if(e!==this.$lastMouseMoveTarget){this.$lastMouseMoveTarget=e,h([].slice.call(e.parentNode.children),function(e){e.classList.contains("hover")&&e.classList.remove("hover")}),e.classList.add("hover");var t=e.parentNode.dataset.level,i=a.selects[t].data[n(e)];a.$showSelect(a.selects[t],i)}}),c(this.refs.selectContainer,"eas-select-item","click",function(e){a.$selectItem(a.selects[e.parentNode.dataset.level].display[n(e)]),e.classList.add("selected")},!0),c(this.refs.tags,"eas-tag","click",function(e){a.$removeItem(n(e))}),t(document.body,i.selectContainer),t(this.el,i.container),this.$buildMainSelelt();var r=this.data[0][0];this.config.cache&&(window.addEventListener("unload",function(){a.$saveCache()}),this.cache&&this.cache[location.pathname]&&this.cache[location.pathname][this.currentType]&&(r=o([],this.cache[location.pathname][this.currentType]),0===r.length&&(r=this.data[0][0]))),h(r.reverse(),function(e){a.$selectItem(e)}),this.config.onReady&&this.config.onReady()}},$buildTypeList:function(){var e=this;this.config.types.length>1?(h(this.config.types,function(i){t(e.refs.typeList,l("li",{className:"type-list-item",innerHTML:i}))}),this.refs.type.classList.add("list")):i(this.refs.typeList)},$buildMainSelelt:function(){for(var e=0,t=[];this.data[e];)h(this.data[e],function(i){h(i,function(i){i.level=e,t.push(i)})}),e++;this.data.all=t},$showSelect:function(e,i){if(e){if(this.$hideSelect(e.level+1),i.level>=this.data.struct.length-1)return;var s=this.$generateSelect(i.level+1,i.i),n=e.el.getBoundingClientRect();s.style.top=this.$selectTop+"px",s.style.left=n.left+n.width-1+"px",t(this.refs.selectContainer,s)}else this.$hideSelect(1),this.$refreshMainSelect()},$hideSelect:function(e){for(;e<this.data.struct.length;e++)this.selects[e]&&(i(this.selects[e].el),this.selects[e]=null)},$refreshMainSelect:function(){var e=this,i=this.data.all;this.keyword&&(i=this.data.all.filter(function(t){return t.n.toUpperCase().indexOf(e.keyword.toUpperCase())>-1}));var s=this.refs.input.getBoundingClientRect();this.$selectTop=s.top+s.height;var n=this.$generateSelect(0,0,i);n.style.left=s.left-1+"px",n.style.top=this.$selectTop+"px",t(this.refs.selectContainer,n)},$generateSelect:function(e,i,s){if(this.data[e]){0===e&&(i=0);var n=l("ul",{className:"eas-select"},{level:e}),a=this.data[e][i];0===e&&(a=this.data.all),s&&(a=s);var r={el:n,data:a,level:e,display:a,fullLoaded:!0},c=this,d=this.config.selectSliceLength,u=this.config.selectItemStyle.height,f=this.config.selectItemStyle.display;return a.length>d&&(r.fullLoaded=!1,r.display=a.slice(0,d),n.addEventListener("scroll",function(){r.fullLoaded||this.scrollTop/u+f>r.display.length&&(h(r.data.slice(r.display.length-1,r.display.length+d),function(e){t(n,c.$generateSelectItem(e))}),r.display=r.data.slice(0,r.display.length+d),r.display>=r.data&&(r.fullLoaded=!0))})),h(r.display,function(e){t(n,c.$generateSelectItem(e))}),this.selects[e]&&this.selects[e].el&&(o(n.style,this.selects[e].el.style),this.refs.selectContainer.replaceChild(n,this.selects[e].el)),this.selects[e]=r,n}},$generateSelectItem:function(e){var t="eas-select-item";this.model.some(function(t){return t.i===e.i&&t.level===e.level})&&(t+=" selected");var i=l("li",{className:t});return i.innerHTML="<small>"+e.level+"</small><i>"+this.data.struct[e.level]+"</i><span>"+e.n+"</span>",i},$setCurrentLevel:function(e){e>0&&e<this.data.struct.length?this.currentLevel=e:this.currentLevel=0},$selectItem:function(e){this.model.some(function(t){return t.i===e.i&&t.level===e.level})||(this.model.unshift(e),this.$setCurrentLevel(e.level),this.$refreshModel())},$removeItem:function(e){this.model.splice(e,1);var t=this.currentLevel;0===this.model.length?this.$setCurrentLevel(0):this.model.some(function(e){return e.level===t})||this.$setCurrentLevel(this.model[0].level),this.$refreshModel()},$clearAll:function(){this.model=[],this.$refreshModel()},getModel:function(){if(!this.model.length)return{level:1,data:""};var e={},t=this.currentLevel;return e.level=t+1,e.data=this.model.filter(function(e){return e.level===t}).map(function(e){return e.i}).join(","),e},$refreshModel:function(){var e=this.currentLevel;this.refs.tags.innerHTML=this.model.map(function(t){var i="eas-tag";return t.level!==e&&(i+=" disabled"),'<li class="'+i+'"><span>'+t.n+"</span><i></i></li>"}).join(""),this.$setCache(),this.config.onChange&&this.config.onChange()},$initCache:function(){var e=window.localStorage.getItem(this.config.cacheKey),t={};if(e)try{t=JSON.parse(e),this.cache=t}catch(i){this.cache={}}else this.cache={}},$setCache:function(){this.cache[window.location.pathname]||(this.cache[window.location.pathname]={}),this.cache[window.location.pathname][this.currentType]=o([],this.model)},$saveCache:function(){window.localStorage.setItem(this.config.cacheKey,JSON.stringify(this.cache))},$search:function(){this.keyword=this.refs.input.value.trim(),this.$showSelect()}},"object"==typeof exports?module.exports=e:window.AreaSelector=e}();