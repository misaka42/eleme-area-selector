!function(){function e(e,t){this.el=e,this.config=Object.assign({},d,t),this.init()}function t(){var e=Array.prototype.slice.call(arguments),t=e.shift();e.forEach(function(e){t.appendChild(e)})}function s(e){e&&("function"==typeof e.remove?e.remove():e.parentNode.removeChild(e))}function i(e){for(var t in e)return!1;return!0}function n(e){return[].indexOf.call(e.parentNode.children,e)}function l(e,t,s){var i=document.createElement(e);return t&&Object.assign(i,t),s&&Object.assign(i.dataset,s),i}function r(e){return e?"?"+Object.keys(e).map(function(t){return t+"="+e[t]}).join("&"):""}function a(e,t){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){if(s.responseText){var e=JSON.parse(s.responseText);200===e.code&&e.data?t(e.data):console.error(e)}}else if(s.status&&200!==s.status)throw new Error(s.responseText)},s.withCredentials=!0,s.open(e.method||"GET",e.url+r(e.params)),s.send()}function o(e,t,s,i,n){e.addEventListener(s,function(s){for(var l=s.target;l&&l!==e;)l.classList.contains(t)&&(i(l),n&&s.stopPropagation()),l=l.parentNode})}function c(e,t){if(e){if(Array.isArray(e)&&"function"==typeof e.forEach)return void e.forEach(t);for(var s in e)e.hasOwnProperty(s)&&t(e[s])}}var h={},d={origin:"/api/other/filter/",styleCDN:"//npm.elemecdn.com/eleme-area-selector@0.1.15/dist/style.css",typeMap:{"交易平台BU":{id:"bu",params:{time:"hour"}},"红包":{id:"redReward"},BOD:{id:"bod"},"高校":{id:"business/gx"},"白领":{id:"business/bl"},"早餐":{id:"breakfast"},"城市补贴与优惠":{id:"cityAllowance"},"城市":{id:"cityAllowance"}},onReady:null,onChange:null,onTypeChange:null,types:["交易平台BU"]};e.prototype={init:function(){this.el.innerHTML="Loading Style...";var e=this;this.__configStyle(function(){e.setCurrentType(e.config.types[0])})},__configStyle:function(e){if(document.querySelector("[data-id=EAS-Style]"))e();else{var t=l("link",{rel:"stylesheet",href:this.config.styleCDN},{id:"EAS-Style"});t.onload=e,document.head.appendChild(t)}},setCurrentType:function(e){this.currentType=e,this.refresh(),this.config.onTypeChange&&this.config.onTypeChange(e)},refresh:function(){this.el.innerHTML="Loading Data...",this.model=[],this.data={},this.keyword="",this.selects={},i(this.refs)||this.__destroy(),h[this.currentType]?this.__build(h[this.currentType]):a({url:this.config.origin+this.config.typeMap[this.currentType].id,params:this.config.typeMap[this.currentType].params},this.__build.bind(this))},__destroy:function(){this.__eventsHandlerRemove.forEach(function(e){e()}),this.__eventsHandlerRemove=[],s(this.refs.container),s(this.refs.selectContainer),this.refs={}},__addEventListener:function(e,t,s){e.addEventListener(t,s),this.__eventsHandlerRemove.push(function(){e.removeEventListener(t,s)})},__build:function(e){this.data=e,h[this.currentType]=e;var s=this.refs={},i=this;this.__eventsHandlerRemove=[],s.container=l("div",{className:"eas-container"}),s.inputContainer=l("div",{className:"input-container"}),s.typeBox=l("div",{className:"type-box"}),s.type=l("div",{className:"current-type"}),s.typeList=l("ul",{className:"type-list"}),s.input=l("input",{className:"eas-input",type:"search"}),s.resultContainer=l("div",{className:"result-container"}),s.clearAll=l("div",{className:"clear-all",innerHTML:"清除全部"}),s.tags=l("div",{className:"eas-tags"}),s.selectContainer=l("div",{className:"eas-selects"}),this.el.innerHTML="",t(s.container,s.inputContainer,s.resultContainer),t(s.typeBox,s.type,s.typeList),t(s.inputContainer,s.typeBox,s.input),t(s.resultContainer,s.tags,s.clearAll),this.refs.type.innerHTML=this.currentType,this.__buildTypeList(),this.__addEventListener(document.body,"click",function(){i.hideSelect(0)}),this.__addEventListener(this.refs.input,"click",function(e){i.showSelect(),e.stopPropagation()}),this.__addEventListener(this.refs.input,"input",function(){i.search()}),this.__addEventListener(this.refs.clearAll,"click",function(){i.clearAll()}),o(this.refs.typeList,"type-list-item","click",function(e){i.setCurrentType(e.textContent)},!0),o(this.refs.selectContainer,"eas-select-item","mousemove",function(e){if(e!==this.__lastMouseMoveTarget){this.__lastMouseMoveTarget=e,[].slice.call(e.parentNode.children).forEach(function(e){e.classList.contains("hover")&&e.classList.remove("hover")}),e.classList.add("hover");var t=e.parentNode.dataset.level,s=i.selects[t].data[n(e)];i.showSelect(i.selects[t],s)}}),o(this.refs.selectContainer,"eas-select-item","click",function(e){i.__selectItem(i.selects[e.parentNode.dataset.level].display[n(e)]),e.classList.add("selected")},!0),o(this.refs.tags,"eas-tag","click",function(e){i.__removeItem(n(e))}),t(document.body,s.selectContainer),t(this.el,s.container),this.__buildMainSelelt(),this.data[0][0].forEach(function(e){i.__selectItem(e)}),this.config.onReady&&this.config.onReady()},__buildTypeList:function(){var e=this;this.config.types.length>1?c(this.config.types,function(s){t(e.refs.typeList,l("li",{className:"type-list-item",innerHTML:s}))}):s(this.refs.typeList)},__buildMainSelelt:function(){for(var e=0,s=[];this.data[e];)c(this.data[e],function(t){c(t,function(t){t.level=e,s.push(t)})}),e++;this.data.all=s;var i=this.refs.input.getBoundingClientRect();this.__selectTop=i.top+i.height;var n=this.__generateSelect(0);n.style.left=i.left-1+"px",n.style.top=this.__selectTop+"px",n.style.display="none",t(this.refs.selectContainer,n)},showSelect:function(e,s){if(e){if(this.hideSelect(e.level+1),s.level>=this.data.struct.length-1)return;var i=this.__generateSelect(s.level+1,s.i),n=e.el.getBoundingClientRect();i.style.top=this.__selectTop+"px",i.style.left=n.left+n.width-1+"px",t(this.refs.selectContainer,i)}else this.refreshMainSelect(),this.selects[0].el.style.display="block",this.hideSelect(1)},hideSelect:function(e){for(0===e&&(this.selects[0].el.style.display="none",e++);e<this.data.struct.length;e++)this.selects[e]&&(s(this.selects[e].el),this.selects[e]=null)},refreshMainSelect:function(){var e=this,t=this.data.all;this.keyword&&(t=this.data.all.filter(function(t){return t.n.toUpperCase().indexOf(e.keyword.toUpperCase())>-1})),this.__generateSelect(0,0,t)},__generateSelect:function(e,s,i){if(this.data[e]){0===e&&(s=0);var n=l("ul",{className:"eas-select"},{level:e}),r=this.data[e][s];0===e&&(r=this.data.all),i&&(r=i);var a={el:n,data:r,level:e},o=new DocumentFragment,c=this;return a.display=r,r.length>200&&(a.display=r.slice(0,200),n.addEventListener("scroll",function(){if(this.scrollTop/27+20>a.display.length){var e=new DocumentFragment;a.data.slice(a.display.length-1,a.display.length+200).forEach(function(s){t(e,c.__generateSelectItem(s))}),t(this,e),a.display=a.data.slice(0,a.display.length+200)}})),a.display.forEach(function(e){t(o,c.__generateSelectItem(e))}),t(n,o),this.selects[e]&&this.selects[e].el&&(Object.assign(n.style,this.selects[e].el.style),this.refs.selectContainer.replaceChild(n,this.selects[e].el)),this.selects[e]=a,n}},__generateSelectItem:function(e){var t="eas-select-item";this.model.some(function(t){return t.i===e.i&&t.level===e.level})&&(t+=" selected");var s=l("li",{className:t});return s.innerHTML="<small>"+e.level+"</small><i>"+this.data.struct[e.level]+"</i><span>"+e.n+"</span>",s},setCurrentLevel:function(e){e>0&&e<this.data.struct.length?this.currentLevel=e:this.currentLevel=0},__selectItem:function(e){this.model.some(function(t){return t.i===e.i&&t.level===e.level})||(this.model.unshift(e),this.setCurrentLevel(e.level),this.refreshModel())},__removeItem:function(e){this.model.splice(e,1);var t=this.currentLevel;0===this.model.length?this.setCurrentLevel(0):this.model.some(function(e){return e.level===t})||this.setCurrentLevel(Math.max.apply(null,this.model.map(function(e){return e.level}))),this.refreshModel()},clearAll:function(){this.model=[],this.refreshModel()},getModel:function(){if(!this.model.length)return{level:"",data:""};var e={},t=this.currentLevel;return e.level=t+1,e.data=this.model.filter(function(e){return e.level===t}).map(function(e){return e.i}).join(","),e},refreshModel:function(){var e=this.currentLevel;this.refs.tags.innerHTML=this.model.map(function(t){var s="eas-tag";return t.level!==e&&(s+=" disabled"),'<li class="'+s+'"><span>'+t.n+"</span><i></i></li>"}).join(""),this.config.onChange&&this.config.onChange()},search:function(){this.keyword=this.refs.input.value.trim(),this.showSelect()}},"object"==typeof exports?module.exports=e:window.AreaSelector=e}();