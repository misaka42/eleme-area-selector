!function(){function e(e,t){this.el=e,this.config=Object.assign({},v,t),this.$init()}function t(){var e=[].slice.call(arguments),t=e.shift();e.forEach(function(e){t.appendChild(e)})}function i(e){e&&("function"==typeof e.remove?e.remove():e.parentNode.removeChild(e))}function s(e){for(var t in e)return!1;return!0}function n(e){return[].indexOf.call(e.parentNode.children,e)}function a(e,t,i){var s=document.createElement(e);return t&&Object.assign(s,t),i&&Object.assign(s.dataset,i),s}function l(e){return e?"?"+Object.keys(e).map(function(t){return t+"="+e[t]}).join("&"):""}function c(e,t){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState&&200===i.status){if(i.responseText){var e=JSON.parse(i.responseText);e?t(e):console.error(e)}}else if(i.status&&200!==i.status)throw new Error(i.responseText)},i.withCredentials=!0,i.open(e.method||"GET",e.url+l(e.params)),i.send()}function r(e,t,i,s,n){e.addEventListener(i,function(i){for(var a=i.target;a&&a!==e;)a.classList.contains(t)&&(s(a),n&&i.stopPropagation()),a=a.parentNode})}function o(e,t){if(e){if(Array.isArray(e)&&"function"==typeof e.forEach)return void e.forEach(t);for(var i in e)e.hasOwnProperty(i)&&t(e[i])}}var h="0.2.6",d={},u={"交易平台BU":{id:"bu",params:{time:"hour"}},"红包":{id:"redReward"},BOD:{id:"bod"},"高校":{id:"business/gx"},"白领":{id:"business/bl"},"早餐":{id:"breakfast"},"城市补贴与优惠":{id:"cityAllowance"},"城市":{id:"cityAllowance"}},f="/api/other/filter/",p=function(e,t){e.data&&200===e.code?t(e.data):console.error(e.code,e.message)},y="//npm.elemecdn.com/eleme-area-selector@"+h+"/dist/style.css",v={api:f,style:y,selectItemStyle:{height:27,display:20},selectSliceLength:200,typeMap:u,onReady:null,onChange:null,onTypeChange:null,loadingMessage:["正在加载资源...","正在请求数据..."],types:["交易平台BU"],cache:!1,cacheKey:"EAS-CACHE",responseHandler:p};e.version=h,e.prototype={$init:function(){if(this.el.innerHTML=this.config.loadingMessage[0],this.$initCache(),document.querySelector("[data-id=EAS-Style]"))this.$setCurrentType();else{var e=a("link",{rel:"stylesheet",href:this.config.style},{id:"EAS-Style"}),i=this;e.onload=function(){i.$setCurrentType()},t(document.head,e)}},$setCurrentType:function(e){e||(e=this.config.types[0]),this.config.onTypeChange&&this.config.onTypeChange(e),this.currentType=e,this.$load()},$load:function(){this.el.innerHTML=this.config.loadingMessage[1],this.model=[],this.data={},this.keyword="",this.selects={},s(this.refs)||this.$clear(),this.refs={},d[this.currentType]?this.$build(d[this.currentType]):c({url:this.config.api+this.config.typeMap[this.currentType].id,params:this.config.typeMap[this.currentType].params},function(e){this.config.responseHandler?this.config.responseHandler(e,this.$build.bind(this)):this.$build(e)}.bind(this))},$clear:function(){this.$eventsHandlerRemove.forEach(function(e){e()}),this.$eventsHandlerRemove=[],i(this.refs.container),i(this.refs.selectContainer)},$destroy:function(){this.$clear(),this.$saveCache(),this.config.onChange=null,this.config.onReady=null,this.config.onTypeChange=null;var e=this;o(this,function(t){"function"==typeof t&&(e[t]=null)})},$addEventListener:function(e,t,i){e.addEventListener(t,i),this.$eventsHandlerRemove.push(function(){e.removeEventListener(t,i)})},$build:function(e){this.data=e,d[this.currentType]=e;var i=this.refs,s=this;this.$eventsHandlerRemove=[],i.container=a("div",{className:"eas-container"}),i.inputContainer=a("div",{className:"input-container"}),i.typeBox=a("div",{className:"type-box"}),i.type=a("div",{className:"current-type"}),i.typeList=a("ul",{className:"type-list"}),i.input=a("input",{className:"eas-input",type:"search"}),i.resultContainer=a("div",{className:"result-container"}),i.clearAll=a("div",{className:"clear-all",innerHTML:"清除全部"}),i.tags=a("div",{className:"eas-tags"}),i.selectContainer=a("div",{className:"eas-selects"}),this.el.innerHTML="",t(i.container,i.inputContainer,i.resultContainer),t(i.typeBox,i.type,i.typeList),t(i.inputContainer,i.typeBox,i.input),t(i.resultContainer,i.tags,i.clearAll),this.refs.type.innerHTML=this.currentType,this.$buildTypeList(),this.$addEventListener(document.body,"click",function(){s.$hideSelect(0)}),this.$addEventListener(this.refs.input,"click",function(e){s.$showSelect(),e.stopPropagation()}),this.$addEventListener(this.refs.input,"input",function(){s.$search()}),this.$addEventListener(this.refs.clearAll,"click",function(){s.$clearAll()}),r(this.refs.typeList,"type-list-item","click",function(e){s.$setCurrentType(e.textContent)},!0),r(this.refs.selectContainer,"eas-select-item","mousemove",function(e){if(e!==this.$lastMouseMoveTarget){this.$lastMouseMoveTarget=e,[].slice.call(e.parentNode.children).forEach(function(e){e.classList.contains("hover")&&e.classList.remove("hover")}),e.classList.add("hover");var t=e.parentNode.dataset.level,i=s.selects[t].data[n(e)];s.$showSelect(s.selects[t],i)}}),r(this.refs.selectContainer,"eas-select-item","click",function(e){s.$selectItem(s.selects[e.parentNode.dataset.level].display[n(e)]),e.classList.add("selected")},!0),r(this.refs.tags,"eas-tag","click",function(e){s.$removeItem(n(e))}),t(document.body,i.selectContainer),t(this.el,i.container),this.$buildMainSelelt();var l=this.data[0][0];this.config.cache&&(window.addEventListener("unload",function(){s.$saveCache()}),this.cache&&this.cache[location.pathname]&&this.cache[location.pathname][this.currentType]&&(l=Object.assign([],this.cache[location.pathname][this.currentType]),0===l.length&&(l=this.data[0][0]))),l.reverse().forEach(function(e){s.$selectItem(e)}),this.config.onReady&&this.config.onReady()},$buildTypeList:function(){var e=this;this.config.types.length>1?(o(this.config.types,function(i){t(e.refs.typeList,a("li",{className:"type-list-item",innerHTML:i}))}),this.refs.type.classList.add("list")):i(this.refs.typeList)},$buildMainSelelt:function(){for(var e=0,i=[];this.data[e];)o(this.data[e],function(t){o(t,function(t){t.level=e,i.push(t)})}),e++;this.data.all=i;var s=this.refs.input.getBoundingClientRect();this.$selectTop=s.top+s.height;var n=this.$generateSelect(0);n.style.left=s.left-1+"px",n.style.top=this.$selectTop+"px",n.style.display="none",t(this.refs.selectContainer,n)},$showSelect:function(e,i){if(e){if(this.$hideSelect(e.level+1),i.level>=this.data.struct.length-1)return;var s=this.$generateSelect(i.level+1,i.i),n=e.el.getBoundingClientRect();s.style.top=this.$selectTop+"px",s.style.left=n.left+n.width-1+"px",t(this.refs.selectContainer,s)}else this.$refreshMainSelect(),this.selects[0].el.style.display="block",this.$hideSelect(1)},$hideSelect:function(e){for(0===e&&(this.selects[0].el.style.display="none",e++);e<this.data.struct.length;e++)this.selects[e]&&(i(this.selects[e].el),this.selects[e]=null)},$refreshMainSelect:function(){var e=this,t=this.data.all;this.keyword&&(t=this.data.all.filter(function(t){return t.n.toUpperCase().indexOf(e.keyword.toUpperCase())>-1})),this.$generateSelect(0,0,t)},$generateSelect:function(e,i,s){if(this.data[e]){0===e&&(i=0);var n=a("ul",{className:"eas-select"},{level:e}),l=this.data[e][i];0===e&&(l=this.data.all),s&&(l=s);var c={el:n,data:l,level:e,display:l,fullLoaded:!0},r=this,o=this.config.selectSliceLength,h=this.config.selectItemStyle.height,d=this.config.selectItemStyle.display;return l.length>o&&(c.fullLoaded=!1,c.display=l.slice(0,o),n.addEventListener("scroll",function(){c.fullLoaded||this.scrollTop/h+d>c.display.length&&(c.data.slice(c.display.length-1,c.display.length+o).forEach(function(e){t(n,r.$generateSelectItem(e))}),c.display=c.data.slice(0,c.display.length+o),c.display>=c.data&&(c.fullLoaded=!0))})),c.display.forEach(function(e){t(n,r.$generateSelectItem(e))}),this.selects[e]&&this.selects[e].el&&(Object.assign(n.style,this.selects[e].el.style),this.refs.selectContainer.replaceChild(n,this.selects[e].el)),this.selects[e]=c,n}},$generateSelectItem:function(e){var t="eas-select-item";this.model.some(function(t){return t.i===e.i&&t.level===e.level})&&(t+=" selected");var i=a("li",{className:t});return i.innerHTML="<small>"+e.level+"</small><i>"+this.data.struct[e.level]+"</i><span>"+e.n+"</span>",i},$setCurrentLevel:function(e){e>0&&e<this.data.struct.length?this.currentLevel=e:this.currentLevel=0},$selectItem:function(e){this.model.some(function(t){return t.i===e.i&&t.level===e.level})||(this.model.unshift(e),this.$setCurrentLevel(e.level),this.$refreshModel())},$removeItem:function(e){this.model.splice(e,1);var t=this.currentLevel;0===this.model.length?this.$setCurrentLevel(0):this.model.some(function(e){return e.level===t})||this.$setCurrentLevel(this.model[0].level),this.$refreshModel()},$clearAll:function(){this.model=[],this.$refreshModel()},getModel:function(){if(!this.model.length)return{level:1,data:""};var e={},t=this.currentLevel;return e.level=t+1,e.data=this.model.filter(function(e){return e.level===t}).map(function(e){return e.i}).join(","),e},$refreshModel:function(){var e=this.currentLevel;this.refs.tags.innerHTML=this.model.map(function(t){var i="eas-tag";return t.level!==e&&(i+=" disabled"),'<li class="'+i+'"><span>'+t.n+"</span><i></i></li>"}).join(""),this.$setCache(),this.config.onChange&&this.config.onChange()},$initCache:function(){var e=window.localStorage.getItem(this.config.cacheKey),t={};if(e)try{t=JSON.parse(e),this.cache=t}catch(i){this.cache={}}else this.cache={}},$setCache:function(){this.cache[window.location.pathname]||(this.cache[window.location.pathname]={}),this.cache[window.location.pathname][this.currentType]=Object.assign([],this.model)},$saveCache:function(){window.localStorage.setItem(this.config.cacheKey,JSON.stringify(this.cache))},$search:function(){this.keyword=this.refs.input.value.trim(),this.$showSelect()}},"object"==typeof exports?module.exports=e:window.AreaSelector=e}();