!function(){function e(e,t){this.el=e,this.config=Object.assign({},u,t),this.init()}function t(){var e=Array.prototype.slice.call(arguments),t=e.shift();e.forEach(function(e){t.appendChild(e)})}function i(e){"function"==typeof e.remove?e.remove():e.parentNode.removeChild(e)}function s(e){for(var t in e)return!1;return!0}function n(e){return[].indexOf.call(e.parentNode.children,e)}function l(e,t,i){var s=document.createElement(e);return t&&Object.assign(s,t),i&&Object.assign(s.dataset,i),s}function r(e){return e?"?"+Object.keys(e).map(function(t){return t+"="+e[t]}).join("&"):""}function a(e,t){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState&&200===i.status){if(i.responseText){var e=JSON.parse(i.responseText);200===e.code&&e.data?t(e.data):console.error(e)}}else if(i.status&&200!==i.status)throw new Error(i.responseText)},i.withCredentials=!0,i.open(e.method||"GET",e.url+r(e.params)),i.send()}function o(e,t,i,s,n){e.addEventListener(i,function(i){for(var l=i.target;l&&l!==e;)l.classList.contains(t)&&(s(l),n&&i.stopPropagation()),l=l.parentNode})}function c(e,t){if(e){if(Array.isArray(e)&&"function"==typeof e.forEach)return void e.forEach(t);for(var i in e)e.hasOwnProperty(i)&&t(e[i])}}var h={},u={origin:"/api/other/filter/",styleCDN:"//npm.elemecdn.com/eleme-area-selector@0.1.7/dist/style.css",typeMap:{"交易平台BU":{id:"bu",params:{time:"hour"}},"红包":{id:"redReward"},BOD:{id:"bod"},"高校":{id:"business/gx"},"白领":{id:"business/bl"},"早餐":{id:"breakfast"},"城市补贴与优惠":{id:"cityAllowance"},"城市":{id:"cityAllowance"}},onReady:null,onChange:null,onTypeChange:null,types:["交易平台BU"]};e.prototype={init:function(){this.el.innerHTML="Loading Style...";var e=this;this.__configStyle(function(){e.setCurrentType(e.config.types[0])})},__configStyle:function(e){if(document.querySelector("[data-id=EAS-Style]"))e();else{var t=l("link",{rel:"stylesheet",href:this.config.styleCDN},{id:"EAS-Style"});t.onload=e,document.head.appendChild(t)}},setCurrentType:function(e){this.currentType=e,this.refresh(),this.config.onTypeChange&&this.config.onTypeChange(e)},refresh:function(){this.el.innerHTML="Loading Data...",this.model=[],this.data={},this.keyword="",this.selects={},s(this.refs)||(this.__rebuild=!0,i(this.refs.container),i(this.refs.selectContainer)),this.refs={},h[this.currentType]?this.__build(h[this.currentType]):a({url:this.config.origin+this.config.typeMap[this.currentType].id,params:this.config.typeMap[this.currentType].params},this.__build.bind(this))},__build:function(e){this.data=e,h[this.currentType]=e;var i=this.refs,s=this;i.container=l("div",{className:"eas-container"}),i.inputContainer=l("div",{className:"input-container"}),i.typeBox=l("div",{className:"type-box"}),i.type=l("div",{className:"current-type"}),i.typeList=l("ul",{className:"type-list"}),i.input=l("input",{className:"eas-input",type:"search"}),i.resultContainer=l("div",{className:"result-container"}),i.clearAll=l("div",{className:"clear-all",innerHTML:"清除全部"}),i.tags=l("div",{className:"eas-tags"}),i.selectContainer=l("div",{className:"eas-selects"}),this.el.innerHTML="",t(i.container,i.inputContainer,i.resultContainer),t(i.typeBox,i.type,i.typeList),t(i.inputContainer,i.typeBox,i.input),t(i.resultContainer,i.tags,i.clearAll),this.refs.type.innerHTML=this.currentType,this.__buildTypeList(),this.rebuild||document.body.addEventListener("click",function(){s.hideSelect(0)}),this.refs.input.addEventListener("click",function(e){s.showSelect(),e.stopPropagation()}),this.refs.input.addEventListener("input",function(e){s.search()}),this.refs.clearAll.addEventListener("click",function(){s.clearAll()}),o(this.refs.typeList,"type-list-item","click",function(e){s.setCurrentType(e.textContent)},!0),o(this.refs.selectContainer,"eas-select-item","mousemove",function(e){if(e!==this.__lastMouseMoveTarget){this.__lastMouseMoveTarget=e,[].slice.call(e.parentNode.children).forEach(function(e){e.classList.contains("hover")&&e.classList.remove("hover")}),e.classList.add("hover");var t=e.parentNode.dataset.level,i=s.selects[t].data[n(e)];s.showSelect(s.selects[t],i)}}),o(this.refs.selectContainer,"eas-select-item","click",function(e){s.__selectItem(s.selects[e.parentNode.dataset.level].display[n(e)]),e.classList.add("selected")},!0),o(this.refs.tags,"eas-tag","click",function(e){s.__removeItem(n(e))}),t(document.body,i.selectContainer),t(this.el,i.container),this.__buildMainSelelt(),this.data[0][0].forEach(function(e){s.__selectItem(e)}),this.__rebuild=!1,this.config.onReady&&this.config.onReady()},__buildTypeList:function(){var e=this;this.config.types.length>1&&c(this.config.types,function(i){t(e.refs.typeList,l("li",{className:"type-list-item",innerHTML:i}))})},__buildMainSelelt:function(){for(var e=0,i=[];this.data[e];)c(this.data[e],function(t){c(t,function(t){t.level=e,i.push(t)})}),e++;this.data.all=i;var s=this.refs.input.getBoundingClientRect();this.__selectTop=s.top+s.height;var n=this.__generateSelect(0);n.style.left=s.left-1+"px",n.style.top=this.__selectTop+"px",n.style.display="none",t(this.refs.selectContainer,n)},showSelect:function(e,i){if(e){if(this.hideSelect(e.level+1),i.level>=this.data.struct.length-1)return;var s=this.__generateSelect(i.level+1,i.i),n=e.el.getBoundingClientRect();s.style.top=this.__selectTop+"px",s.style.left=n.left+n.width-1+"px",t(this.refs.selectContainer,s)}else this.refreshMainSelect(),this.selects[0].el.style.display="block",this.hideSelect(1)},hideSelect:function(e){for(0===e&&(this.selects[0].el.style.display="none",e++);e<this.data.struct.length;e++)this.selects[e]&&(i(this.selects[e].el),this.selects[e]=null)},refreshMainSelect:function(){var e=this,t=this.data.all;this.keyword&&(t=this.data.all.filter(function(t){return t.n.toUpperCase().indexOf(e.keyword.toUpperCase())>-1})),this.__generateSelect(0,0,t)},__generateSelect:function(e,i,s){if(this.data[e]){0===e&&(i=0);var n=l("ul",{className:"eas-select"},{level:e}),r=this.data[e][i];0===e&&(r=this.data.all),s&&(r=s);var a={el:n,data:r,level:e},o=new DocumentFragment,c=this;return a.display=r,r.length>200&&(a.display=r.slice(0,200),n.addEventListener("scroll",function(){if(this.scrollTop/27+20>a.display.length){var e=new DocumentFragment;a.data.slice(a.display.length-1,a.display.length+200).forEach(function(i){t(e,c.__generateSelectItem(i))}),t(this,e),a.display=a.data.slice(0,a.display.length+200)}})),a.display.forEach(function(e){t(o,c.__generateSelectItem(e))}),t(n,o),this.selects[e]&&this.selects[e].el&&(Object.assign(n.style,this.selects[e].el.style),this.refs.selectContainer.replaceChild(n,this.selects[e].el)),this.selects[e]=a,n}},__generateSelectItem:function(e){var t="eas-select-item";this.model.some(function(t){return t.i===e.i&&t.level===e.level})&&(t+=" selected");var i=l("li",{className:t});return i.innerHTML="<small>"+e.level+"</small><i>"+this.data.struct[e.level]+"</i><span>"+e.n+"</span>",i},setCurrentLevel:function(e){e>0&&e<this.data.struct.length-1?this.currentLevel=e:this.currentLevel=0},__selectItem:function(e){this.model.some(function(t){return t.i===e.i&&t.level===e.level})||(this.model.unshift(e),this.setCurrentLevel(e.level),this.refreshModel())},__removeItem:function(e){this.model.splice(e,1);var t=this.currentLevel;0===this.model.length?this.setCurrentLevel(0):this.model.some(function(e){return e.level===t})||this.setCurrentLevel(Math.max.apply(null,this.model.map(function(e){return e.level}))),this.refreshModel()},clearAll:function(){this.model=[],this.refreshModel()},getModel:function(){if(!this.model.length)return{level:"",data:""};var e={},t=this.currentLevel;return e.level=t+1,e.data=this.model.filter(function(e){return e.level===t}).map(function(e){return e.i}).join(","),e},refreshModel:function(){var e=this.currentLevel;this.refs.tags.innerHTML=this.model.map(function(t){var i="eas-tag";return t.level!==e&&(i+=" disabled"),'<li class="'+i+'"><span>'+t.n+"</span><i></i></li>"}).join(""),this.config.onChange&&this.config.onChange()},search:function(){this.keyword=this.refs.input.value.trim(),this.showSelect()}},"object"==typeof exports?module.exports=e:"function"==typeof define&&define.amd?define([],e):window.AreaSelector=e}();